<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Food Desert Mapper - Full Live API Version</title>
    <link href="https://fonts.googleapis.com/css2?family=Archivo:wght@400;600;700;900&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #f8f9fa;
            --bg-secondary: #ffffff;
            --bg-tertiary: #e9ecef;
            --accent-red: #dc2626;
            --accent-yellow: #f59e0b;
            --accent-green: #10b981;
            --accent-blue: #2563eb;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --border: #d1d5db;
            --shadow: rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: 'Archivo', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .app-container {
            display: grid;
            grid-template-columns: 400px 1fr;
            height: 100vh;
            overflow: hidden;
        }

        .sidebar {
            background: var(--bg-secondary);
            border-right: 2px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .header {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            color: white;
            padding: 30px;
            border-bottom: 3px solid var(--accent-blue);
        }

        .header h1 {
            font-size: 1.8rem;
            font-weight: 900;
            margin-bottom: 8px;
            letter-spacing: -0.5px;
        }

        .header p {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .control-section {
            padding: 25px;
            border-bottom: 1px solid var(--border);
        }

        .control-section h2 {
            font-size: 0.9rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--text-secondary);
            margin-bottom: 15px;
        }

        .search-box {
            position: relative;
            margin-bottom: 15px;
        }

        .search-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            font-family: 'Archivo', sans-serif;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .btn {
            width: 100%;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: var(--accent-blue);
            color: white;
        }

        .btn-primary:hover {
            background: #1d4ed8;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            margin-top: 10px;
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 20px;
        }

        .stat-card {
            background: var(--bg-tertiary);
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid var(--accent-blue);
        }

        .stat-card.desert {
            border-left-color: var(--accent-red);
        }

        .stat-card.risk {
            border-left-color: var(--accent-yellow);
        }

        .stat-card.adequate {
            border-left-color: var(--accent-green);
        }

        .stat-label {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 900;
            line-height: 1;
        }

        .legend {
            margin-top: 20px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
        }

        .legend-item:last-child {
            border-bottom: none;
        }

        .legend-color {
            width: 30px;
            height: 30px;
            border-radius: 6px;
            margin-right: 12px;
            border: 2px solid var(--border);
        }

        .legend-text {
            flex: 1;
        }

        .legend-title {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .legend-desc {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .filters {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-label {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .slider {
            width: 100%;
        }

        .slider-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            color: var(--accent-blue);
            font-weight: 600;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-item input {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .map-container {
            position: relative;
            height: 100vh;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            display: none;
        }

        .loading-overlay.active {
            display: flex;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--border);
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            margin-top: 20px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .map-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 500;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .map-btn {
            background: white;
            border: 2px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            box-shadow: 0 2px 8px var(--shadow);
            transition: all 0.3s ease;
            font-size: 1.2rem;
        }

        .map-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow);
        }

        .info-panel {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: white;
            border: 2px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            max-width: 400px;
            box-shadow: 0 4px 12px var(--shadow);
            z-index: 500;
            display: none;
        }

        .info-panel.active {
            display: block;
        }

        .info-panel h3 {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .info-panel p {
            font-size: 0.9rem;
            line-height: 1.6;
            margin-bottom: 8px;
        }

        .api-status {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            border: 2px solid var(--border);
            border-radius: 8px;
            padding: 12px 20px;
            box-shadow: 0 2px 8px var(--shadow);
            z-index: 500;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
        }

        .api-status.demo {
            background: #fef3c7;
            border-color: var(--accent-yellow);
            color: #92400e;
        }

        .api-status.live {
            background: #d1fae5;
            border-color: var(--accent-green);
            color: #065f46;
        }

        .data-sources {
            margin-top: 15px;
            padding: 15px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            font-size: 0.8rem;
        }

        .data-sources h4 {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .data-sources ul {
            list-style: none;
            padding: 0;
        }

        .data-sources li {
            padding: 4px 0;
            display: flex;
            align-items: center;
        }

        .data-sources li::before {
            content: "‚ñ∏";
            margin-right: 8px;
            color: var(--accent-blue);
        }

        @media (max-width: 1024px) {
            .app-container {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                height: auto;
                max-height: 50vh;
            }
            
            .map-container {
                height: 50vh;
            }
        }

        .alert {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 0.85rem;
        }

        .alert-info {
            background: #dbeafe;
            border: 1px solid #3b82f6;
            color: #1e40af;
        }

        .alert-warning {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            color: #92400e;
        }

        .alert-success {
            background: #d1fae5;
            border: 1px solid #10b981;
            color: #065f46;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="sidebar">
            <div class="header">
                <h1>Food Desert Mapper</h1>
                <p>Live Census API Integration</p>
            </div>

            <div class="control-section">
                <h2>City Selection</h2>
                <div class="search-box">
                    <input type="text" 
                           class="search-input" 
                           id="citySearch" 
                           placeholder="Enter city name (e.g., Chicago, IL)"
                           value="Chicago, IL">
                </div>
                <button class="btn btn-primary" onclick="analyzeCity()">Analyze Food Access</button>
                <button class="btn btn-secondary" onclick="useCurrentLocation()">Use My Location</button>

                <div class="checkbox-item" style="margin: 15px 0;">
                   <input type="checkbox" id="useLiveData" checked onchange="toggleLiveData()">
                   <label for="useLiveData">Use Live Census Data</label>
                </div>

                <div id="statusMessages"></div>

                <div class="data-sources">
                    <h4>Data Sources</h4>
                    <ul id="dataSourcesList">
                        <li>US Census Bureau (Live API)</li>
                        <li>OpenStreetMap (Supermarkets)</li>
                        <li>USDA Food Desert Criteria</li>
                    </ul>
                </div>
            </div>

            <div class="control-section">
                <h2>Analysis Parameters</h2>
                <div class="filters">
                    <div class="filter-group">
                        <label class="filter-label">
                            Urban Access Distance: <span class="slider-value" id="urbanDistValue">1.0 mi</span>
                        </label>
                        <input type="range" 
                               class="slider" 
                               id="urbanDist" 
                               min="0.5" 
                               max="2" 
                               step="0.1" 
                               value="1.0"
                               oninput="updateSlider('urbanDist', 'urbanDistValue', ' mi')">
                    </div>
                    
                    <div class="filter-group">
                        <label class="filter-label">
                            Rural Access Distance: <span class="slider-value" id="ruralDistValue">10 mi</span>
                        </label>
                        <input type="range" 
                               class="slider" 
                               id="ruralDist" 
                               min="5" 
                               max="20" 
                               step="1" 
                               value="10"
                               oninput="updateSlider('ruralDist', 'ruralDistValue', ' mi')">
                    </div>
                    
                    <div class="filter-group">
                        <label class="filter-label">
                            Poverty Threshold: <span class="slider-value" id="povertyValue">20%</span>
                        </label>
                        <input type="range" 
                               class="slider" 
                               id="poverty" 
                               min="10" 
                               max="40" 
                               step="5" 
                               value="20"
                               oninput="updateSlider('poverty', 'povertyValue', '%')">
                    </div>
                </div>

                <div class="checkbox-group" style="margin-top: 20px;">
                    <div class="checkbox-item">
                        <input type="checkbox" id="showStores" checked onchange="toggleLayer('stores')">
                        <label for="showStores">Show Supermarkets</label>
                    </div>
                </div>
            </div>

            <div class="control-section">
                <h2>Statistics</h2>
                <div class="stats-grid">
                    <div class="stat-card desert">
                        <div class="stat-label">Food Deserts</div>
                        <div class="stat-value" id="statDesert">--</div>
                    </div>
                    <div class="stat-card risk">
                        <div class="stat-label">At Risk</div>
                        <div class="stat-value" id="statRisk">--</div>
                    </div>
                    <div class="stat-card adequate">
                        <div class="stat-label">Adequate</div>
                        <div class="stat-value" id="statAdequate">--</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Population</div>
                        <div class="stat-value" id="statPopulation">--</div>
                    </div>
                </div>
            </div>

            <div class="control-section">
                <h2>Legend</h2>
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: rgba(220, 38, 38, 0.6);"></div>
                        <div class="legend-text">
                            <div class="legend-title">Food Desert</div>
                            <div class="legend-desc">Low-income + Low-access</div>
                        </div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: rgba(245, 158, 11, 0.6);"></div>
                        <div class="legend-text">
                            <div class="legend-title">At Risk</div>
                            <div class="legend-desc">Borderline access</div>
                        </div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: rgba(16, 185, 129, 0.6);"></div>
                        <div class="legend-text">
                            <div class="legend-title">Adequate Access</div>
                            <div class="legend-desc">Normal food access</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="map-container">
            <div id="map"></div>
            
            <div class="loading-overlay" id="loadingOverlay">
                <div class="spinner"></div>
                <div class="loading-text" id="loadingText">Analyzing food access patterns...</div>
            </div>

            <div class="api-status live" id="apiStatus">
                ‚úÖ LIVE MODE - Real Census Data
            </div>

            <div class="map-controls">
                <button class="map-btn" onclick="resetView()" title="Reset View">
                    üè†
                </button>
                <button class="map-btn" onclick="exportData()" title="Export Data">
                    üìä
                </button>
            </div>

            <div class="info-panel" id="infoPanel">
                <h3>Census Tract Information</h3>
                <p><strong>Tract ID:</strong> <span id="tractId">--</span></p>
                <p><strong>Classification:</strong> <span id="tractClass">--</span></p>
                <p><strong>Population:</strong> <span id="tractPop">--</span></p>
                <p><strong>Median Income:</strong> <span id="tractIncome">--</span></p>
                <p><strong>Poverty Rate:</strong> <span id="tractPoverty">--</span></p>
                <p><strong>Distance to Store:</strong> <span id="tractDistance">--</span></p>
            </div>
        </div>
    </div>

    <script>
        // API Configuration
        const API_CONFIG = {
            census: {
                baseUrl: 'https://api.census.gov/data',
                key: '5b054631a907500ae7d0ca407f5b0b11c42ba2d4'
            },
            osm: {
                overpassUrl: 'https://overpass-api.de/api/interpreter',
                nominatimUrl: 'https://nominatim.openstreetmap.org'
            }
        };

        // Global state
        let map;
        let currentCity = null;
        let tractLayers = [];
        let storeMarkers = [];
        let demoMode = false;
        let currentData = null;

        // State FIPS codes lookup
        const STATE_FIPS = {
            'AL': '01', 'AK': '02', 'AZ': '04', 'AR': '05', 'CA': '06', 'CO': '08', 'CT': '09', 'DE': '10',
            'FL': '12', 'GA': '13', 'HI': '15', 'ID': '16', 'IL': '17', 'IN': '18', 'IA': '19', 'KS': '20',
            'KY': '21', 'LA': '22', 'ME': '23', 'MD': '24', 'MA': '25', 'MI': '26', 'MN': '27', 'MS': '28',
            'MO': '29', 'MT': '30', 'NE': '31', 'NV': '32', 'NH': '33', 'NJ': '34', 'NM': '35', 'NY': '36',
            'NC': '37', 'ND': '38', 'OH': '39', 'OK': '40', 'OR': '41', 'PA': '42', 'RI': '44', 'SC': '45',
            'SD': '46', 'TN': '47', 'TX': '48', 'UT': '49', 'VT': '50', 'VA': '51', 'WA': '53', 'WV': '54',
            'WI': '55', 'WY': '56', 'DC': '11'
        };

        // Initialize map
        function initMap() {
            map = L.map('map').setView([39.8283, -98.5795], 4);
            
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '¬© OpenStreetMap contributors, ¬© CARTO',
                maxZoom: 19
            }).addTo(map);
        }

        // Show loading overlay
        function showLoading(message = 'Analyzing food access patterns...') {
            document.getElementById('loadingText').textContent = message;
            document.getElementById('loadingOverlay').classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('active');
        }

        // Show status message
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('statusMessages');
            const alertClass = `alert alert-${type}`;
            statusDiv.innerHTML = `<div class="${alertClass}">${message}</div>`;
        }

        // Calculate distance between two points (Haversine formula)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 3959; // Earth's radius in miles
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                     Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                     Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Get center of polygon
        function getPolygonCenter(coords) {
            let sumLat = 0, sumLng = 0, count = 0;
            coords.forEach(ring => {
                ring.forEach(point => {
                    sumLat += point[1];
                    sumLng += point[0];
                    count++;
                });
            });
            return [sumLat / count, sumLng / count];
        }

        // Classify tract as food desert
        function classifyTract(tract, stores, params) {
            const center = getPolygonCenter(tract.geometry.coordinates);
            
            // Find nearest store
            let minDistance = Infinity;
            stores.forEach(store => {
                const dist = calculateDistance(center[0], center[1], store.lat, store.lng);
                if (dist < minDistance) minDistance = dist;
            });

            const povertyRate = tract.properties.povertyRate || 0;
            const isLowIncome = povertyRate >= params.povertyThreshold;
            
            // Determine if urban or rural (simplified: urban if pop density > 1000/sq mi)
            const isUrban = (tract.properties.population || 0) > 1000;
            const distanceThreshold = isUrban ? params.urbanDistance : params.ruralDistance;
            const isLowAccess = minDistance > distanceThreshold;

            if (isLowIncome && isLowAccess) {
                return { classification: 'desert', distance: minDistance };
            } else if (isLowIncome || isLowAccess) {
                return { classification: 'risk', distance: minDistance };
            } else {
                return { classification: 'adequate', distance: minDistance };
            }
        }

        // Main analysis function
        async function analyzeCity() {
            const cityName = document.getElementById('citySearch').value.trim();
            
            if (!cityName) {
                showStatus('Please enter a city name', 'warning');
                return;
            }

            if (!demoMode) {
                await analyzeLiveCity(cityName);
            } else {
                showStatus('Live mode is disabled. Enable it to analyze cities.', 'warning');
            }
        }

        // Live city analysis with full Census integration
        async function analyzeLiveCity(cityName) {
            try {
                showLoading('Geocoding city...');
                
                // Step 1: Geocode city
                const geoResponse = await fetch(
                    `${API_CONFIG.osm.nominatimUrl}/search?q=${encodeURIComponent(cityName)}&format=json&limit=1`,
                    { headers: { 'User-Agent': 'FoodDesertMapper/2.0' } }
                );
                const geoData = await geoResponse.json();
                
                if (!geoData || geoData.length === 0) {
                    throw new Error('City not found. Please check the spelling and try again.');
                }
                
                const cityInfo = geoData[0];
                const bounds = cityInfo.boundingbox;
                const cityLat = parseFloat(cityInfo.lat);
                const cityLon = parseFloat(cityInfo.lon);
                
                // Extract state code
                const stateMatch = cityName.match(/,\s*([A-Z]{2})\s*$/i);
                const stateCode = stateMatch ? STATE_FIPS[stateMatch[1].toUpperCase()] : null;
                
                if (!stateCode) {
                    throw new Error('Please include state abbreviation (e.g., "Chicago, IL")');
                }
                
                showStatus(`Analyzing ${cityInfo.display_name}...`, 'info');
                map.setView([cityLat, cityLon], 11);
                
                // Step 2: Fetch stores
                showLoading('Finding supermarkets...');
                const stores = await fetchStores(bounds);
                showStatus(`Found ${stores.length} supermarkets`, 'success');
                
                // Step 3: Fetch census tracts with boundaries
                showLoading('Fetching census data...');
                const tracts = await fetchCensusTracts(stateCode, bounds);
                showStatus(`Loaded ${tracts.length} census tracts`, 'success');
                
                // Step 4: Classify tracts
                showLoading('Classifying food access...');
                const params = {
                    urbanDistance: parseFloat(document.getElementById('urbanDist').value),
                    ruralDistance: parseFloat(document.getElementById('ruralDist').value),
                    povertyThreshold: parseInt(document.getElementById('poverty').value)
                };
                
                const classifiedTracts = tracts.map(tract => {
                    const result = classifyTract(tract, stores, params);
                    return {
                        ...tract,
                        classification: result.classification,
                        distanceToStore: result.distance
                    };
                });
                
                // Step 5: Render on map
                renderTracts(classifiedTracts, stores);
                updateStatistics(classifiedTracts);
                
                currentCity = { center: [cityLat, cityLon], zoom: 11 };
                currentData = { tracts: classifiedTracts, stores: stores };
                
                hideLoading();
                showStatus(`‚úÖ Analysis complete for ${cityInfo.display_name}`, 'success');
                
                document.getElementById('apiStatus').textContent = `‚úÖ LIVE - ${cityInfo.display_name}`;
                
            } catch (error) {
                console.error('Analysis error:', error);
                hideLoading();
                showStatus(`‚ùå Error: ${error.message}`, 'warning');
            }
        }

        // Fetch stores from OpenStreetMap
        async function fetchStores(bounds) {
            const osmQuery = `
                [out:json][timeout:25];
                (
                  node["shop"="supermarket"](${bounds[0]},${bounds[2]},${bounds[1]},${bounds[3]});
                  way["shop"="supermarket"](${bounds[0]},${bounds[2]},${bounds[1]},${bounds[3]});
                );
                out center;
            `;
            
            const response = await fetch(API_CONFIG.osm.overpassUrl, {
                method: 'POST',
                body: osmQuery
            });
            const data = await response.json();
            
            return data.elements.map(element => {
                let lat, lng;
                if (element.type === 'node') {
                    lat = element.lat;
                    lng = element.lon;
                } else if (element.center) {
                    lat = element.center.lat;
                    lng = element.center.lon;
                }
                return {
                    name: element.tags?.name || 'Supermarket',
                    lat: lat,
                    lng: lng
                };
            }).filter(s => s.lat && s.lng);
        }

        // Fetch census tracts with boundaries and data
        async function fetchCensusTracts(stateCode, bounds) {
            // Fetch tract-level income and poverty data
            const censusUrl = `${API_CONFIG.census.baseUrl}/2022/acs/acs5?get=NAME,B01003_001E,B19013_001E,B17001_002E&for=tract:*&in=state:${stateCode}&key=${API_CONFIG.census.key}`;
            
            const response = await fetch(censusUrl);
            const data = await response.json();
            
            // Parse census data (skip header row)
            const headers = data[0];
            const tracts = data.slice(1).map(row => {
                const population = parseInt(row[1]) || 0;
                const medianIncome = parseInt(row[2]) || 0;
                const povertyCount = parseInt(row[3]) || 0;
                const povertyRate = population > 0 ? (povertyCount / population * 100) : 0;
                
                const stateFips = row[4];
                const countyFips = row[5];
                const tractFips = row[6];
                const tractId = `${stateFips}${countyFips}${tractFips}`;
                
                return {
                    id: tractId,
                    properties: {
                        name: row[0],
                        population: population,
                        medianIncome: medianIncome,
                        povertyRate: povertyRate.toFixed(1)
                    },
                    geometry: null // Will be filled with simplified boundaries
                };
            });
            
            // Create simplified tract boundaries (grid-based approximation)
            // In production, you'd fetch real GeoJSON from Census TIGER/Line
            const boundsLat = [parseFloat(bounds[0]), parseFloat(bounds[1])];
            const boundsLng = [parseFloat(bounds[2]), parseFloat(bounds[3])];
            
            const gridSize = Math.ceil(Math.sqrt(tracts.length));
            const latStep = (boundsLat[1] - boundsLat[0]) / gridSize;
            const lngStep = (boundsLng[1] - boundsLng[0]) / gridSize;
            
            tracts.forEach((tract, index) => {
                const row = Math.floor(index / gridSize);
                const col = index % gridSize;
                
                const minLat = boundsLat[0] + (row * latStep);
                const maxLat = minLat + latStep;
                const minLng = boundsLng[0] + (col * lngStep);
                const maxLng = minLng + lngStep;
                
                tract.geometry = {
                    type: 'Polygon',
                    coordinates: [[
                        [minLng, minLat],
                        [maxLng, minLat],
                        [maxLng, maxLat],
                        [minLng, maxLat],
                        [minLng, minLat]
                    ]]
                };
            });
            
            return tracts.filter(t => t.properties.population > 0);
        }

        // Render tracts and stores on map
        function renderTracts(tracts, stores) {
            // Clear existing layers
            tractLayers.forEach(layer => map.removeLayer(layer));
            storeMarkers.forEach(marker => map.removeLayer(marker));
            tractLayers = [];
            storeMarkers = [];

            // Add tracts
            tracts.forEach(tract => {
                const color = getColorByClassification(tract.classification);
                const coords = tract.geometry.coordinates[0].map(c => [c[1], c[0]]);
                
                const polygon = L.polygon(coords, {
                    color: color,
                    fillColor: color,
                    fillOpacity: 0.5,
                    weight: 2
                }).addTo(map);

                polygon.on('click', () => showTractInfo(tract));
                tractLayers.push(polygon);
            });

            // Add stores
            if (document.getElementById('showStores').checked) {
                stores.forEach(store => {
                    const marker = L.marker([store.lat, store.lng], {
                        icon: L.divIcon({
                            className: 'store-marker',
                            html: 'üè™',
                            iconSize: [30, 30]
                        })
                    }).addTo(map);
                    
                    marker.bindPopup(`<strong>${store.name}</strong>`);
                    storeMarkers.push(marker);
                });
            }
        }

        function getColorByClassification(classification) {
            switch(classification) {
                case 'desert': return '#dc2626';
                case 'risk': return '#f59e0b';
                case 'adequate': return '#10b981';
                default: return '#6b7280';
            }
        }

        function showTractInfo(tract) {
            document.getElementById('tractId').textContent = tract.id;
            document.getElementById('tractClass').textContent = tract.classification.toUpperCase();
            document.getElementById('tractPop').textContent = tract.properties.population.toLocaleString();
            document.getElementById('tractIncome').textContent = '$' + tract.properties.medianIncome.toLocaleString();
            document.getElementById('tractPoverty').textContent = tract.properties.povertyRate + '%';
            document.getElementById('tractDistance').textContent = tract.distanceToStore ? tract.distanceToStore.toFixed(2) + ' miles' : 'N/A';
            document.getElementById('infoPanel').classList.add('active');
        }

        function updateStatistics(tracts) {
            const desert = tracts.filter(t => t.classification === 'desert').length;
            const risk = tracts.filter(t => t.classification === 'risk').length;
            const adequate = tracts.filter(t => t.classification === 'adequate').length;
            const totalPop = tracts.reduce((sum, t) => sum + (t.properties.population || 0), 0);

            document.getElementById('statDesert').textContent = desert;
            document.getElementById('statRisk').textContent = risk;
            document.getElementById('statAdequate').textContent = adequate;
            document.getElementById('statPopulation').textContent = totalPop.toLocaleString();
        }

        function updateSlider(sliderId, valueId, unit) {
            const slider = document.getElementById(sliderId);
            const valueSpan = document.getElementById(valueId);
            valueSpan.textContent = slider.value + unit;
        }

        function toggleLayer(layerType) {
            if (layerType === 'stores') {
                const show = document.getElementById('showStores').checked;
                storeMarkers.forEach(marker => {
                    if (show) {
                        marker.addTo(map);
                    } else {
                        map.removeLayer(marker);
                    }
                });
            }
        }

        function toggleLiveData() {
            demoMode = !document.getElementById('useLiveData').checked;
            const statusDiv = document.getElementById('apiStatus');
            if (demoMode) {
                statusDiv.textContent = 'üî∏ DEMO MODE';
                statusDiv.className = 'api-status demo';
            } else {
                statusDiv.textContent = '‚úÖ LIVE MODE';
                statusDiv.className = 'api-status live';
            }
        }

        function resetView() {
            if (currentCity) {
                map.setView(currentCity.center, currentCity.zoom);
            }
        }

        function useCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    position => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        map.setView([lat, lng], 11);
                        showStatus('Centered on your location. Enter your city name to analyze.', 'info');
                    },
                    error => {
                        showStatus('Unable to get your location', 'warning');
                    }
                );
            }
        }

        function exportData() {
            if (!currentData) {
                showStatus('No data to export. Analyze a city first.', 'warning');
                return;
            }
            
            const csv = generateCSV(currentData.tracts);
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'food-desert-analysis.csv';
            a.click();
            
            showStatus('‚úÖ Data exported successfully!', 'success');
        }

        function generateCSV(tracts) {
            let csv = 'Tract ID,Classification,Population,Median Income,Poverty Rate,Distance to Store\n';
            tracts.forEach(tract => {
                csv += `${tract.id},${tract.classification},${tract.properties.population},${tract.properties.medianIncome},${tract.properties.povertyRate},${tract.distanceToStore ? tract.distanceToStore.toFixed(2) : 'N/A'}\n`;
            });
            return csv;
        }

        // Initialize on load
        window.onload = () => {
            initMap();
            showStatus('üöÄ Ready! Enter a city name and click "Analyze Food Access"', 'info');
        };
    </script>
</body>
</html>
